= givethModule
Willie Laubenheimer, <willie@m1d4s.tech>
:toc:

This is the documentation of the giveth Module from Midas Technologies AG for the @melonproject/protocol.

<<<

== Testing

IMPORTANT: For now, all tests below are on the *ropsten testnet*.


=== 1. Stage

The first stage is just about the Bridge Contract from giveth (@giveht/giveth-bridge).

NOTE: We use the WETH token `0x758E94c97caf81d0d0624B272278fe9cd2bdDfB8`.

<<<
==== 1. Deploy the giveth-bridge.sol

Constructor Arguments are:

- absoluteMinTimeLock: `uint256 90,000`
- escapeHatchCaller: `address 0x812ea1c4C193Ffa12a3789405E3050a066FCbE25`
- escapeHatchDestination: `address 0x812ea1c4C193Ffa12a3789405E3050a066FCbE25`
- maxSecurityGuardDelay: `uint256 432,000`
- securityGuard: `address 0x812ea1c4C193Ffa12a3789405E3050a066FCbE25`
- timeLock: `uint256 172,800`

NOTE: The deployed address is https://ropsten.etherscan.io/address/0xa2c8a0f4fa277c9c50f5b36c7ddc5c86404da655[`0xA2C8a0F4Fa277c9c50f5B36C7DDC5C86404dA655`].

<<<
==== 2. Test donate Ether on the Bridge

. Execute `donateAndCreateGiver(address giver, uint64 receiver)` from `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e` with the inputs:

- `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e`
- `1`

. Tx hash: https://ropsten.etherscan.io/tx/0x72d4d506275409fb5010fc12719f41c4eee28a06ed38fe5923e7501f6c875f39[`0x72d4d506275409fb5010fc12719f41c4eee28a06ed38fe5923e7501f6c875f39`].
. Observables:

* Gas used: `29,738`
* Events:
	** Testing:
		*** messageSender from called function: `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e`
		*** messageSender from internal called function: `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e`
		*** seeThis from internal called function: `0xA2C8a0F4Fa277c9c50f5B36C7DDC5C86404dA655`
	** Origin:
		*** DonateAndCreateGiver

Everything worked as expected.

<<<
==== 3. Test donate ERC20 on the Bridge

IMPORTANT: This works without a whitelisting on the Bridge, because we added the constructor to whitelist our WETH token.

First testrun will be without an ERC20 approval for the Bridge. Expected behaiviour is to get a failing tx at the internal tx from the WETH contract.

(i) Execute `donateAndCreateGiver(address giver, uint64 receiver, address token, uint amount)` from `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e` with the inputs:

- `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e`
- `1`
- `0x758E94c97caf81d0d0624B272278fe9cd2bdDfB8`
- `1000000000000000` which is 0.001 WETH.

Successfull not successfull :) (https://ropsten.etherscan.io/tx/0x64b0eda6983ba481b43d11cf8d532ef1f05f6c21a8b81ea05877361f68f1d9bd[See here])

* Gas used: `32,905`
* InternalTx:
	** 1 from `0xA2C8a0F4Fa277c9c50f5B36C7DDC5C86404dA655` (the Bridge) to `0x758E94c97caf81d0d0624B272278fe9cd2bdDfB8` (WETH token).

NOTE: There are no events triggered.

WARNING: Since  the token tranfser failed, we expected an error, as set in the following picture. But we see just `Fail` on etherscan...

image::ERC20errorMsg.png[]

Now we approve `0xA2C8a0F4Fa277c9c50f5B36C7DDC5C86404dA655` (the Bridge) for `1000000000000000` (0.001).

Execute `approve(address guy, uint amout)` on the WETH token contract from `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e`. https://ropsten.etherscan.io/tx/0x30c1474af09c607d7565a47ec4e09c458fcdebdb6e902e57cf022478f4bb90fa[(See here.)]

*Repeat (i).*

https://ropsten.etherscan.io/tx/0x4de5d9ce87f0d1a49cc67f4c921ce0ac86a79d846ae52e35829f3572c6f21667[Worked as expected.]

* Gas used: `54,740`
* InternalTX:
	** 1 from `0xA2C8a0F4Fa277c9c50f5B36C7DDC5C86404dA655`(the Bridge) to `0x758E94c97caf81d0d0624B272278fe9cd2bdDfB8`(WETH token).
* https://ropsten.etherscan.io/tx/0x4de5d9ce87f0d1a49cc67f4c921ce0ac86a79d846ae52e35829f3572c6f21667#eventlog[Events:]
	** Testing:
		*** messageSender from called function: `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e`
		*** messageSender from internal called function: `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e`
		*** seeThis from internal called function: `0xA2C8a0F4Fa277c9c50f5B36C7DDC5C86404dA655`
	** Origin:
		*** Transfer from `0x173add8c7e4f7034e9ca41c5d2d8a0a986fd427e` amount `1000000000000000` to `0xA2C8a0F4Fa277c9c50f5B36C7DDC5C86404dA655` (ERC20 Event)
		*** DonateAndCreateGiver (Bridge Contract Event)

<<<
==== Summary 1. Stage testing

Now we have finished the first Stage testing successfully. A few things we need to save for further testing.

. To transfer the ERC20 token we need to set an approval on the ERC20 token contract. (In this stage we needed to approve the Bridge.)
. The gas used for an ERC20 donation directly via the Bridge was around `55000`.
. To donate ETH directly the contract needed around `30000` gas.

<<<
=== 2. Stage
